name: 11ì£¼ì°¨ ê³¼ì œ ì±„ì  (ìž…ë ¥ ì‹œë®¬ë ˆì´ì…˜ ë° í”„ë¡¬í”„íŠ¸ ë¬´ì‹œ)

on: [push]

jobs:
build-and-test:
runs-on: ubuntu-latest

steps:
  - name: ðŸ—‚ï¸ ì½”ë“œ ì²´í¬ì•„ì›ƒ
    uses: actions/checkout@v3

  - name: ðŸ† í†µí•© ì±„ì  ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (100ì  ë§Œì )
    id: grading
    run: |
      # ANSI ìƒ‰ìƒ ì½”ë“œ ì •ì˜
      GREEN='\033[32m'
      RED='\033[31m'
      BLUE='\033[34m'
      NC='\033[0m' # No Color

      FINAL_SCORE=0
      FINAL_FEEDBACK=""
      TEST_NAME="í•™ìƒ ì„±ì  ê´€ë¦¬ í”„ë¡œê·¸ëž¨ (ìž…ë ¥ ì‹œë®¬ë ˆì´ì…˜)"
      
      # Normalize function: ëª¨ë“  ê³µë°±ì„ ì œê±°í•˜ê³  ë¹„êµí•˜ì—¬, ì¶œë ¥ ë‚´ìš© ìžì²´ì˜ ì¼ì¹˜ ì—¬ë¶€ë§Œ í™•ì¸í•©ë‹ˆë‹¤.
      normalize_output() {
          # íƒ­, ì¤„ë°”ê¿ˆ, ê³µë°± ë“±ì„ ëª¨ë‘ í•˜ë‚˜ì˜ ê³µë°±ìœ¼ë¡œ ì¹˜í™˜ í›„, ì•žë’¤ ê³µë°± ì œê±°
          cat "$1" | tr -d '\t\n\r' | sed 's/[[:space:]]\+/ /g' | sed 's/^ *//;s/ *$//'
      }

      echo -e "\n${BLUE}--- [TEST] ${TEST_NAME} ì±„ì  ì‹œìž‘ ---${NC}"

      # ----------------------------------------------------
      # 1. íŒŒì¼ ì¡´ìž¬ ì—¬ë¶€ í™•ì¸
      # ----------------------------------------------------
      if [ ! -f "main.c" ]; then
        FINAL_SCORE=0
        FINAL_FEEDBACK="${RED}[FAIL]${NC} ì œì¶œ íŒŒì¼(main.c)ì´ ì¡´ìž¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. íŒŒì¼ì„ í™•ì¸í•˜ì„¸ìš”."
        echo -e "${RED}Error: main.c íŒŒì¼ ì—†ìŒ.${NC}"
      else
        # ----------------------------------------------------
        # 2. ì»´íŒŒì¼ ì‹œë„
        # ----------------------------------------------------
        if gcc main.c -o student_manager -lm 2> compile_error.txt; then
          echo -e "${GREEN}[OK]${NC} ${TEST_NAME}: ì»´íŒŒì¼ ì„±ê³µ."
          
          # 2-1. ì˜ˆìƒ ì¶œë ¥ íŒŒì¼ ìƒì„±
          # ìµœì¢… ê²°ê³¼ëŠ” í•­ìƒ 3ì¤„ìž…ë‹ˆë‹¤.
          printf "Average: 86.6\nHigh: Choi - 92ì \nLow: Kim - 80ì \n" > expected_output.txt

          # 2-2. ìž…ë ¥ ì‹œë®¬ë ˆì´ì…˜ ë° ì‹¤í–‰ (í”„ë¡¬í”„íŠ¸ ì¶œë ¥ í¬í•¨)
          # í•™ìƒ ìˆ˜ 5ëª… + 5ëª…ì˜ í•™ë²ˆ, ì´ë¦„, ì„±ì 
          INPUT_DATA="5\n20251111\nkim\n80\n20251112\nLee\n90\n20251113\nPark\n87\n20251114\nChoi\n92\n20251115\nYoon\n84"
          
          # ì‹¤í–‰ ê²°ê³¼ë¥¼ ìº¡ì²˜í•©ë‹ˆë‹¤. (í•™ìƒì˜ í”„ë¡¬í”„íŠ¸ ì¶œë ¥ì´ í¬í•¨ë¨)
          echo -e "$INPUT_DATA" | ./student_manager > actual_output_raw.txt
          
          # 2-3. ì¶œë ¥ ì •ë¦¬ (ê²°ê³¼ë§Œ ì¶”ì¶œ)
          # **** í•µì‹¬ ìˆ˜ì • ì‚¬í•­: 'tail -n 3' ëª…ë ¹ì–´ë¡œ í”„ë¡¬í”„íŠ¸ë¥¼ ë¬´ì‹œí•˜ê³  ìµœì¢… ê²°ê³¼ 3ì¤„ë§Œ ì¶”ì¶œí•©ë‹ˆë‹¤. ****
          tail -n 3 actual_output_raw.txt > actual_output.txt

          # 2-4. ì¶œë ¥ ë¹„êµ
          EXPECTED_CLEAN=$(normalize_output expected_output.txt)
          ACTUAL_CLEAN=$(normalize_output actual_output.txt)

          if [[ "$ACTUAL_CLEAN" == "$EXPECTED_CLEAN" ]]; then
            FINAL_SCORE=100
            FINAL_FEEDBACK="${GREEN}[OK]${NC} ${TEST_NAME}: í†µê³¼ (100ì ). ìµœì¢… ê²°ê³¼ 3ì¤„ì´ ì •í™•í•©ë‹ˆë‹¤."
          else
            FINAL_FEEDBACK="${RED}[FAIL]${NC} ${TEST_NAME}: ìµœì¢… ì¶œë ¥ ë¶ˆì¼ì¹˜. (0ì )"
            FINAL_FEEDBACK="${FINAL_FEEDBACK}\n  [ì˜ˆìƒ ì¶œë ¥ (ì •ê·œí™”)]: ${EXPECTED_CLEAN}"
            FINAL_FEEDBACK="${FINAL_FEEDBACK}\n  [í•™ìƒ ì¶œë ¥ (ì •ê·œí™”)]: ${ACTUAL_CLEAN}"
            FINAL_FEEDBACK="${FINAL_FEEDBACK}\n\n[íŒ]: í‰ê·  ì†Œìˆ˜ì  ìžë¦¬, ì´ë¦„/ì ìˆ˜ ì¶œë ¥ í¬ë§· ('ì ' í¬í•¨), ë„ì–´ì“°ê¸°, ëŒ€ì†Œë¬¸ìž ë“±ì´ ì˜ˆìƒ ì¶œë ¥ê³¼ ì •í™•ížˆ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”. (ê²°ê³¼ëŠ” ë§ˆì§€ë§‰ 3ì¤„ì— ì¶œë ¥ë˜ì–´ì•¼ í•¨)"
          fi
        else
          FINAL_SCORE=0
          FINAL_FEEDBACK="${RED}[FAIL]${NC} ${TEST_NAME}: ì»´íŒŒì¼ ì‹¤íŒ¨. ì½”ë“œë¥¼ í™•ì¸í•˜ì„¸ìš”."
          FINAL_FEEDBACK="${FINAL_FEEDBACK}\n\n[ì»´íŒŒì¼ ì—ëŸ¬]:\n$(cat compile_error.txt)"
        fi
      fi

      # ----------------------------------------------------
      # 3. ìµœì¢… ì ìˆ˜ ë° í”¼ë“œë°± ì „ì†¡ (GitHub Classroom ë³´ê³ )
      # ----------------------------------------------------
      
      FULL_FEEDBACK="--- ìµœì¢… ì±„ì  ê²°ê³¼ (ì´ ${FINAL_SCORE}ì  / 100ì ) ---\n"
      FULL_FEEDBACK="${FULL_FEEDBACK}\n${FINAL_FEEDBACK}"
      
      echo "score=$FINAL_SCORE" >> "$GITHUB_OUTPUT"
      echo "feedback<<EOF" >> "$GITHUB_OUTPUT"
      echo -e "$FULL_FEEDBACK" >> "$GITHUB_OUTPUT"
      echo "EOF" >> "$GITHUB_OUTPUT"

      # 4. Action ì‹¤íŒ¨ ì²˜ë¦¬
      if [ $FINAL_SCORE -ne 100 ]; then
        exit 1
      fi
