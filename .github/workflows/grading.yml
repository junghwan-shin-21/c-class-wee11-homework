name: 학생 성적 관리 프로그램 채점

on: [push]

jobs:
grade:
runs-on: ubuntu-latest
steps:
- name: 코드 체크아웃
uses: actions/checkout@v3

  - name: 채점 스크립트 실행
    id: grading
    run: |
      # ----------------------------------------------------
      # 1. 초기 변수 설정 및 공백 제거 함수 정의
      # ----------------------------------------------------
      SCORE=0
      FEEDBACK=""
      
      # [핵심 기능] normalize_output: 모든 공백(space, tab, newline, carriage return)을 제거합니다.
      normalize_output() {
        tr -d ' \t\n\r' < "$1"
      }
      
      # ----------------------------------------------------
      # 2. 컴파일 시도
      # ----------------------------------------------------
      if gcc main.c -o student_manager; then
        FEEDBACK="[OK] 컴파일 성공.\n"
        
        # ----------------------------------------------------
        # 3. 예상 출력 파일 생성
        # ----------------------------------------------------
        # 테스트 데이터 입력 (5명의 학생)
        # 학생 수: 5
        # 1번 학번: 101, 이름: Alice, 성적: 88.5
        # 2번 학번: 102, 이름: Bob, 성적: 92.0 (High)
        # 3번 학번: 103, 이름: Charlie, 성적: 75.3 (Low)
        # 4번 학번: 104, 이름: David, 성적: 92.0
        # 5번 학번: 105, 이름: Eve, 성적: 88.5

        # 예상 결과 (계산 결과: 평균 87.66 -> 87.7, High 92, Low 75)
        # YML의 예상 출력은 C 코드의 엄격한 출력 형식(High: Bob-92점, Low: Charlie-75점)을 따라야 합니다.
        printf "Average: 87.7\n" > expected_output_core.txt
        printf "High: Bob-92점\n" >> expected_output_core.txt
        printf "Low: Charlie-75점\n" >> expected_output_core.txt

        # ----------------------------------------------------
        # 4. 실행 및 출력 캡처
        # ----------------------------------------------------
        # 테스트 입력 데이터 (프롬프트 응답 포함)
        INPUT_DATA="5\n101\nAlice\n88.5\n102\nBob\n92.0\n103\nCharlie\n75.3\n104\nDavid\n92.0\n105\nEve\n88.5\n"
        
        # INPUT_DATA를 실행 파일에 pipe로 연결하고 출력을 캡처
        echo -e "$INPUT_DATA" | ./student_manager > raw_output.txt

        # ----------------------------------------------------
        # 5. 핵심 출력 추출 (프롬프트 제거)
        # ----------------------------------------------------
        # 핵심 결과 라인(Average, High, Low)만 추출하여 actual_output.txt에 저장
        # (프롬프트와 "오류" 메시지 등을 모두 제거)
        grep -E 'Average:|High:|Low:' raw_output.txt > actual_output.txt
        
        # ----------------------------------------------------
        # 6. 최종 비교 및 채점 (공백 무시 비교)
        # ----------------------------------------------------
        if [[ "$(normalize_output actual_output.txt)" == "$(normalize_output expected_output_core.txt)" ]]; then
          SCORE=100
          FEEDBACK="${FEEDBACK}[PASS] 모든 테스트 케이스 통과! (100점)\n"
        else
          SCORE=0
          FEEDBACK="${FEEDBACK}[FAIL] 출력 형식이 일치하지 않습니다. (0점)\n"
          FEEDBACK="${FEEDBACK}  [기대하는 핵심 출력 (정규화 전)]:\n$(cat expected_output_core.txt)\n"
          FEEDBACK="${FEEDBACK}  [학생/테스트 출력 (정규화 전)]:\n$(cat actual_output.txt)\n"
          echo "::error::채점 실패: 출력 내용 불일치."
        fi

      else
        SCORE=0
        FEEDBACK="[FAIL] 컴파일 실패. 코드를 확인하세요."
        echo "::error::컴파일 실패."
      fi

      # ----------------------------------------------------
      # 7. GitHub Classroom 최종 점수 및 피드백 전달
      # ----------------------------------------------------
      echo "score=$SCORE" >> "$GITHUB_OUTPUT"
      echo "feedback<<EOF" >> "$GITHUB_OUTPUT"
      echo -e "$FEEDBACK" >> "$GITHUB_OUTPUT"
      echo "EOF" >> "$GITHUB_OUTPUT"
      
      # 최종 점수가 100점이 아니면 GitHub Actions에서 실패 처리
      if [ "$SCORE" -ne 100 ]; then
         exit 1
      fi
